<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
    <title>Code Generator</title>
    
    <!-- QR Code library - 100% совместима с iOS Safari -->
    <script src="https://cdn.jsdelivr.net/npm/qrcodejs@1.0.0/qrcode.min.js"></script>
    
    <style>
        * {
            box-sizing: border-box;
            -webkit-tap-highlight-color: transparent;
        }
        
        html, body {
            margin: 0;
            padding: 0;
            width: 100%;
            height: 100%;
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, Helvetica, Arial, sans-serif;
            background-color: #f8f9fa;
            overflow: hidden;
            position: fixed;
        }
        
        body {
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            padding: 20px;
            text-align: center;
        }
        
        #app-container {
            width: 100%;
            max-width: 500px;
            display: flex;
            flex-direction: column;
            align-items: center;
            background-color: white;
            border-radius: 12px;
            box-shadow: 0 4px 12px rgba(0,0,0,0.1);
            padding: 20px;
            margin-bottom: 20px;
        }
        
        h1 {
            color: #333;
            font-size: 1.5rem;
            margin-top: 0;
            margin-bottom: 10px;
        }
        
        p {
            color: #666;
            margin-bottom: 20px;
            font-size: 0.9rem;
        }
        
        #code-container {
            width: 100%;
            display: flex;
            justify-content: center;
            margin: 20px 0;
            padding: 15px;
            background-color: #f8f9fa;
            border-radius: 8px;
        }
        
        #qrcode {
            margin: 0 auto;
        }
        
        #current-code {
            width: 100%;
            font-family: monospace;
            font-size: 14px;
            background-color: #f0f0f0;
            padding: 12px;
            border-radius: 8px;
            word-break: break-all;
            text-align: center;
            margin-bottom: 15px;
        }
        
        #timer {
            color: #888;
            font-size: 0.85rem;
            margin-top: 10px;
            padding: 5px 12px;
            background-color: #f0f0f0;
            border-radius: 12px;
        }
        
        #controls {
            width: 100%;
            display: flex;
            justify-content: center;
            margin-top: 15px;
        }
        
        button {
            background-color: #4285f4;
            color: white;
            border: none;
            border-radius: 50px;
            padding: 12px 24px;
            font-size: 1rem;
            font-weight: 500;
            cursor: pointer;
            -webkit-appearance: none;
            appearance: none;
        }
        
        button:active {
            background-color: #3367d6;
        }
        
        @media (max-width: 480px) {
            h1 {
                font-size: 1.3rem;
            }
            
            #current-code {
                font-size: 12px;
            }
            
            button {
                padding: 10px 20px;
                font-size: 0.9rem;
            }
        }
        
        .no-select {
            -webkit-touch-callout: none;
            -webkit-user-select: none;
            user-select: none;
        }
    </style>
</head>
<body class="no-select" ontouchmove="event.preventDefault()">
    <div id="app-container">
        <h1>Code Generator</h1>
        <p>Refreshes automatically every 2 seconds</p>
        
        <div id="code-container">
            <div id="qrcode"></div>
        </div>
        
        <div id="current-code"></div>
        <div id="timer">Next update in 2 seconds</div>
        
        <div id="controls">
            <button id="refresh-button" ontouchstart="">Generate New Code</button>
        </div>
    </div>
    
    <script>
        // Base part of the code that remains constant - includes everything except the last 5 chars
        const baseCode = "0104810223038676210OMk76G";
        // Track previously generated suffix codes to avoid duplicates
        const usedSuffixes = new Set();
        let timerInterval;
        let countdownInterval;
        let seconds = 2;
        let isRunning = true;
        let qrcode;
        
        // Function to generate a random alphanumeric character
        function getRandomChar() {
            const chars = "ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz0123456789";
            return chars.charAt(Math.floor(Math.random() * chars.length));
        }
        
        // Function to generate a unique 5-character suffix
        function generateUniqueSuffix() {
            let suffix;
            do {
                suffix = "";
                for (let i = 0; i < 5; i++) {
                    suffix += getRandomChar();
                }
            } while (usedSuffixes.has(suffix));
            
            usedSuffixes.add(suffix);
            if (usedSuffixes.size > 1000) {
                const iterator = usedSuffixes.values();
                usedSuffixes.delete(iterator.next().value);
            }
            
            return suffix;
        }
        
        // Функция генерации QR-кода
        function generateCode() {
            const suffix = generateUniqueSuffix();
            const completeCode = baseCode + suffix;
            
            // Display the current code
            document.getElementById('current-code').textContent = completeCode;
            
            // Reset countdown timer
            seconds = 2;
            document.getElementById('timer').textContent = 'Next update in 2 seconds';
            
            // Если QR-код уже существует, обновляем его, иначе создаем новый
            if (qrcode) {
                qrcode.clear();
                qrcode.makeCode(completeCode);
            } else {
                // Создаем новый QR-код
                qrcode = new QRCode(document.getElementById("qrcode"), {
                    text: completeCode,
                    width: 200,
                    height: 200,
                    colorDark: "#000000",
                    colorLight: "#ffffff",
                    correctLevel: QRCode.CorrectLevel.H // Высокий уровень коррекции ошибок
                });
            }
        }
        
        // Function to start the timer and countdown
        function startTimers() {
            if (timerInterval) clearInterval(timerInterval);
            if (countdownInterval) clearInterval(countdownInterval);
            
            isRunning = true;
            
            // Update the code every 2 seconds
            timerInterval = setInterval(generateCode, 2000);
            
            // Countdown timer for UI
            countdownInterval = setInterval(function() {
                seconds--;
                if (seconds <= 0) seconds = 2;
                document.getElementById('timer').textContent = `Next update in ${seconds} second${seconds !== 1 ? 's' : ''}`;
            }, 1000);
        }
        
        // Handle page visibility changes to save battery
        document.addEventListener('visibilitychange', function() {
            if (document.hidden) {
                if (timerInterval) clearInterval(timerInterval);
                if (countdownInterval) clearInterval(countdownInterval);
                isRunning = false;
            } else {
                if (!isRunning) {
                    generateCode();
                    startTimers();
                }
            }
        });
        
        // Handle manual refresh button
        document.getElementById('refresh-button').addEventListener('click', function() {
            if (timerInterval) clearInterval(timerInterval);
            if (countdownInterval) clearInterval(countdownInterval);
            
            generateCode();
            startTimers();
        });
        
        // Also handle touchend for better mobile experience
        document.getElementById('refresh-button').addEventListener('touchend', function(e) {
            e.preventDefault();
            
            if (timerInterval) clearInterval(timerInterval);
            if (countdownInterval) clearInterval(countdownInterval);
            
            generateCode();
            startTimers();
        });
        
        // Initialize app
        // Initialize app
        document.addEventListener('DOMContentLoaded', function() {
            generateCode();
            startTimers();
        });
        
        // Backup initialization
        if (document.readyState === 'complete' || document.readyState === 'interactive') {
            setTimeout(function() {
                if (!document.getElementById('qrcode').hasChildNodes()) {
                    generateCode();
                    startTimers();
                }
            }, 1);
        }
    </script>
</body>
</html>